name: Sync, Build and Deploy

on:
  # Run daily at 3am
  schedule:
    - cron: '0 10 * * *'

  # Allow manual triggering with input options
  workflow_dispatch:
    inputs:
      sync_only:
        description: 'Only sync with upstream (no build/deploy)'
        required: false
        default: 'false'
        type: boolean

  # Also run on push to master (for direct commits)
  push:
    branches: ["master"]

jobs:
  sync:
    runs-on: [self-hosted, Linux]
    # Skip this job for push events (only run on schedule or manual trigger)
    if: github.event_name != 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      - name: Setup Upstream Remote
        run: |
          if git remote | grep -q "^upstream$"; then
            echo "Upstream remote already exists, updating URL"
            git remote set-url upstream https://github.com/zabbix/zabbix.git
          else
            echo "Adding upstream remote"
            git remote add upstream https://github.com/zabbix/zabbix.git
          fi
          git fetch upstream

      - name: Merge Upstream Changes
        run: |
          git checkout master
          git fetch upstream
          git checkout -b temp-merge upstream/master
          find .github/workflows -name "*.yml" -not -name "build-container.yaml" -delete || true
          find .github/workflows -name "*.yaml" -not -name "build-container.yaml" -delete || true
          git add .github/workflows/
          git commit -m "Remove conflicting workflows" || true
          git checkout master
          git merge temp-merge -m "Merge upstream with workflow conflicts resolved"          
          git branch -D temp-merge

      - name: Push Changes
        run: |
          git push origin master

  build:
    runs-on: [self-hosted, Linux]
    # Run after sync for schedule/manual events (unless sync_only=true), or directly for push events
    needs: [sync]
    if: always() && (needs.sync.result == 'success' || github.event_name == 'push') && (github.event.inputs.sync_only != 'true')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          # Ensure we get the latest code including any changes from the sync job
          ref: master

      - name: Log in to Docker Registry
        run: |
          echo "${{ secrets.REGISTRY_TOKEN }}" | docker login --username "${{ vars.REGISTRY_USERNAME }}" --password-stdin ${{ vars.REGISTRY_HOSTNAME }}

      - name: Dockerize
        run: |
          docker build -t zabbix:davinci .
          docker tag zabbix:davinci ${{ vars.REGISTRY_HOSTNAME }}/zabbix:davinci
          docker push ${{ vars.REGISTRY_HOSTNAME }}/zabbix:davinci

      - name: Deploy
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          # Create temporary kubeconfig file
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config-temp
          chmod 600 $HOME/.kube/config-temp

          # Set KUBECONFIG and deploy
          export KUBECONFIG=$HOME/.kube/config-temp
          kubectl -n zabbix rollout restart deployment/zabbix

          # Clean up
          rm -f $HOME/.kube/config-temp
